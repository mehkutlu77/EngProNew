<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTER ENGLISH PRO - FINAL 11 MADDE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4f46e5; --success: #22c55e; --danger: #ef4444; 
            --warning: #f59e0b; --bg: #f8fafc; --text: #1e293b;
            --a1: #4ade80; --a2: #22c55e; --b1: #facc15; 
            --b2: #fb923c; --c1: #f87171; --c2: #dc2626;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --btn-height: 65px; /* Madde 11: Geometrik Sabitleme */
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 500px; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.1); }
        .screen { display: none; padding: 25px; animation: fadeIn 0.2s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ANA SAYFA (Madde 3 & 11) */
        .settings-btn { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; z-index: 100; color: white; }
        .streak-card { background: linear-gradient(135deg, #f59e0b, #9333ea); color: white; padding: 35px 20px; border-radius: 20px; text-align: center; margin-bottom: 25px; }
        .level-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
        .level-btn { height: var(--btn-height); border: none; border-radius: 15px; cursor: pointer; font-weight: 800; color: white; font-size: 1.2rem; box-shadow: var(--shadow); transition: 0.2s; }
        .level-btn.selected { border: 4px solid #fff; transform: scale(1.05); }

        /* BUTONLAR & NAV (Madde 11) */
        .btn { width: 100%; height: var(--btn-height); border: none; border-radius: 15px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; box-shadow: var(--shadow); font-size: 1rem; }
        .back-nav { background: #f1f5f9; border: none; padding: 10px 18px; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 20px; display: inline-flex; align-items: center; gap: 5px; }

        /* KART MODU (Madde 10) */
        .card-box { width: 100%; height: 380px; perspective: 1000px; cursor: pointer; margin-bottom: 20px; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; padding: 25px; border-radius: 20px; box-shadow: var(--shadow); border: 1px solid #e2e8f0; background: white; }
        .card-front { align-items: center; justify-content: center; }
        .card-back { transform: rotateY(180deg); overflow-y: auto; text-align: left; display: block; }
        .card-word { font-size: 2.8rem; font-weight: bold; color: var(--primary); }
        .card-detail-item { margin-bottom: 10px; font-size: 0.95rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; }

        /* READING & AUDIO (Madde 4) */
        .audio-panel { background: #f1f5f9; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 12px; }
        .reading-area { line-height: 1.8; font-size: 1.15rem; background: #fff; border: 1px solid #e2e8f0; padding: 20px; border-radius: 15px; max-height: 350px; overflow-y: auto; }
        .word-span { cursor: pointer; border-radius: 4px; padding: 0 2px; transition: 0.2s; }
        .is-unknown { color: var(--primary); font-weight: bold; text-decoration: underline; background: #eef2ff; }

        /* AYARLAR & Y√úKLEME (Madde 11) */
        .upload-section { background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .upload-title { font-weight: bold; margin-bottom: 10px; display: block; color: var(--primary); }
        textarea { width: 100%; height: 80px; border-radius: 10px; border: 1px solid #ddd; padding: 10px; font-size: 0.8rem; resize: none; margin-bottom: 10px; }
        .mini-btn { padding: 8px 15px; border-radius: 8px; border: none; background: #64748b; color: white; cursor: pointer; font-size: 0.8rem; font-weight: bold; }

        /* TOAST (Madde 4) */
        #toast { visibility: hidden; min-width: 200px; background-color: var(--success); color: white; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; transform: translateX(-50%); bottom: 30px; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadinout 2.5s; }
        @keyframes fadinout { 0%,100% { opacity:0; bottom:0; } 15%,85% { opacity:1; bottom:30px; } }
    </style>
</head>
<body>

<div id="toast">‚úÖ Kaydedildi</div>

<div class="app-container">
    <div id="home" class="screen active">
        <div class="settings-btn" onclick="show('settings')">‚öôÔ∏è</div>
        <div class="streak-card"><h1>4 G√úN</h1><p>M√ºhendislik Hassasiyeti üõ†Ô∏è</p></div>
        <div class="level-grid" id="lvlGrid"></div>
        <button class="btn" style="background:var(--primary)" onclick="show('readList')">üìñ Reading Metinleri</button>
        <button class="btn" style="background:var(--primary)" onclick="openCards()">üß† Kelime Kartlarƒ±</button>
        <button class="btn" style="background:#64748b" onclick="showStats()">üìä ƒ∞statistikler</button>
    </div>

    <div id="settings" class="screen">
        <button class="back-nav" onclick="show('home')">‚¨Ö Geri</button>
        <h3>Veri Y√∂netim Merkezi</h3>
        
        <div class="upload-section">
            <span class="upload-title">üî§ Kelime Y√ºkleme (10 S√ºtun)</span>
            <textarea id="wordPaste" placeholder="word | tr | typeEn | ..."></textarea>
            <div style="display:flex; gap:10px;">
                <button class="mini-btn" onclick="handlePaste('word')">Yapƒ±≈ütƒ±rarak Y√ºkle</button>
                <button class="mini-btn" style="background:var(--primary)" onclick="document.getElementById('wordFile').click()">Dosya Se√ß</button>
            </div>
            <input type="file" id="wordFile" style="display:none" onchange="handleFile(this, 'word')">
        </div>

        <div class="upload-section">
            <span class="upload-title">üìñ Reading Y√ºkleme (Blok Format)</span>
            <textarea id="readPaste" placeholder="A1 Ba≈ülƒ±k ..."></textarea>
            <div style="display:flex; gap:10px;">
                <button class="mini-btn" onclick="handlePaste('read')">Yapƒ±≈ütƒ±rarak Y√ºkle</button>
                <button class="mini-btn" style="background:var(--primary)" onclick="document.getElementById('readFile').click()">Dosya Se√ß</button>
            </div>
            <input type="file" id="readFile" style="display:none" onchange="handleFile(this, 'read')">
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn" style="background:#475569; flex:1; height:50px;" onclick="exportJSON()">üì• Yedek Al</button>
            <button class="btn" style="background:#475569; flex:1; height:50px;" onclick="document.getElementById('jsonInp').click()">üì§ Geri Y√ºkle</button>
        </div>
        <input type="file" id="jsonInp" style="display:none" accept=".json" onchange="importJSON(this)">
        <button class="btn" style="background:var(--danger); margin-top:20px; height:50px;" onclick="resetAll()">‚ö†Ô∏è Sistemi Sƒ±fƒ±rla</button>
    </div>

    <div id="readList" class="screen">
        <button class="back-nav" onclick="show('home')">‚¨Ö Geri</button>
        <h3 id="listLvlTitle"></h3>
        <div id="readItems"></div>
    </div>

    <div id="readMod" class="screen">
        <button class="back-nav" onclick="stopS(); show('readList')">‚¨Ö Geri</button>
        <h4 id="readTitle" style="margin:0 0 15px 0;"></h4>
        <div class="audio-panel">
            <button onclick="playS()">‚ñ∂</button><button onclick="pauseS()">‚è∏</button>
            <input type="range" id="speed" min="0.5" max="1.5" step="0.1" value="1" onchange="updateSpd()">
            <span id="speedVal" style="font-weight:bold;">1.0x</span>
        </div>
        <div id="readArea" class="reading-area"></div>
        <button class="btn" style="background:var(--success); margin-top:20px;" onclick="startQuiz()">Testi Ba≈ülat</button>
    </div>

    <div id="quizScreen" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <button class="back-nav" style="margin:0" onclick="show('home')">Ana Sayfa</button>
            <b id="quizProgress"></b>
        </div>
        <h3 id="qText" style="margin-bottom:25px;"></h3>
        <div id="qOptions"></div>
        <button class="btn" style="background:var(--danger); margin-top:20px; height:50px;" onclick="finishQuiz(true)">Testi Bitir</button>
    </div>

    <div id="resultScreen" class="screen">
        <div class="streak-card" style="background:var(--primary)">
            <h1 id="resPercent">%0</h1>
            <p id="resDetail"></p>
        </div>
        <button class="btn" style="background:var(--success)" onclick="show('home')">Ana Sayfaya D√∂n</button>
    </div>

    <div id="cardScreen" class="screen">
        <button class="back-nav" onclick="show('home')">‚¨Ö Geri</button>
        <div id="cardContainer"></div>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:var(--success); flex:1;" onclick="cardAction('know')">Biliyorum ‚úÖ</button>
            <button class="btn" style="background:var(--danger); flex:1;" onclick="cardAction('again')">Tekrar üîÑ</button>
        </div>
        <button id="langToggle" class="btn" style="background:var(--warning); margin-top:10px;" onclick="toggleCardLang()">Eng / Tr Deƒüi≈ütir</button>
    </div>

    <div id="stats" class="screen">
        <button class="back-nav" onclick="show('home')">‚¨Ö Geri</button>
        <canvas id="statsChart" style="max-height: 250px;"></canvas>
        <div id="statsInfo" style="margin-top:20px;"></div>
    </div>
</div>

<script>
    // CORE DATABASE
    let db = { 
        lvl: 'A1', dictionary: [], unknown: [], readings: [], 
        stats: { completed: {}, correct: 0, total: 0 } 
    };

    // STORAGE MGT
    const save = () => localStorage.setItem('master_eng_11', JSON.stringify(db));
    const load = () => { 
        const data = localStorage.getItem('master_eng_11');
        if(data) db = JSON.parse(data);
    };

    function notify(m) { const t = document.getElementById('toast'); t.innerText = m; t.className="show"; setTimeout(()=>t.className="", 2500); }

    // PARSER LOGIC (Madde 1 & 11)
    function processInput(text, type) {
        if(!text.trim()) return;
        if(type === 'word') {
            text.trim().split('\n').forEach(line => {
                const p = line.split('|').map(x => x.trim());
                if(p.length >= 10) {
                    db.dictionary.push({
                        w:p[0].toLowerCase(), tr:p[1], te:p[2], tt:p[3], de:p[4], dt:p[5], e1:p[6], e1t:p[7], e2:p[8], e2t:p[9]
                    });
                }
            });
            notify("Kelime Havuzu G√ºncellendi");
        } else {
            text.split('===YENƒ∞===').forEach(part => {
                if(!part.trim()) return;
                const lines = part.trim().split('\n');
                const firstLine = lines[0].trim();
                const spaceIdx = firstLine.indexOf(" ");
                const level = firstLine.substring(0, spaceIdx);
                const title = firstLine.substring(spaceIdx + 1);
                
                const dashIdx = part.indexOf('---');
                const qIdx = part.indexOf('###SORULAR###');

                const questions = [];
                let currentQ = null;
                part.substring(qIdx + 13).split('\n').forEach(l => {
                    const ln = l.trim();
                    if(ln.startsWith('Q')) {
                        if(currentQ) questions.push(currentQ);
                        currentQ = { q: ln, A:"", B:"", C:"", D:"", correct:"" };
                    } else if(ln.startsWith('Correct:')) {
                        currentQ.correct = ln.split(':')[1].trim();
                    } else if(ln.match(/^[A-D]\)/)) {
                        currentQ[ln[0]] = ln.substring(2).trim();
                    }
                });
                if(currentQ) questions.push(currentQ);

                db.readings.push({
                    lvl: level, title, 
                    en: part.substring(part.indexOf('\n'), dashIdx).trim(),
                    tr: part.substring(dashIdx + 3, qIdx).trim(),
                    qs: questions
                });
            });
            notify("Metinler Havuzu G√ºncellendi");
        }
        save();
    }

    // INTERFACE MGT
    function show(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'readList') renderReadList();
    }

    function setLvl(l) {
        db.lvl = l;
        document.querySelectorAll('.level-btn').forEach(b => b.classList.toggle('selected', b.innerText === l));
        save();
    }

    function handleFile(input, type) {
        const reader = new FileReader();
        reader.onload = (e) => processInput(e.target.result, type);
        reader.readAsText(input.files[0]);
    }

    function handlePaste(type) {
        const el = document.getElementById(type === 'word' ? 'wordPaste' : 'readPaste');
        processInput(el.value, type);
        el.value = "";
    }

    // FLASHCARDS (Madde 10)
    let cIdx = 0; let isEngMode = true;
    function openCards() {
        if(db.unknown.length === 0) return alert("Metin okurken kelime ekleyin!");
        cIdx = 0; isEngMode = true; show('cardScreen'); renderCard();
    }
    function renderCard() {
        const w = db.unknown[cIdx];
        const cont = document.getElementById('cardContainer');
        cont.innerHTML = `
            <div class="card-box" onclick="this.children[0].classList.toggle('flipped')">
                <div class="card-inner">
                    <div class="card-front"><div class="card-word">${w.w}</div><small>Detaylar i√ßin dokun</small></div>
                    <div class="card-back" id="cardBack"></div>
                </div>
            </div>`;
        updateCardContent();
    }
    function updateCardContent() {
        const w = db.unknown[cIdx];
        const back = document.getElementById('cardBack');
        if(isEngMode) {
            back.innerHTML = `<h3>${w.tr}</h3>
                <div class="card-detail-item"><b>Type:</b> ${w.te}</div>
                <div class="card-detail-item"><b>Def:</b> ${w.de}</div>
                <div class="card-detail-item"><b>Ex 1:</b> ${w.e1}</div>
                <div class="card-detail-item"><b>Ex 2:</b> ${w.e2}</div>`;
        } else {
            back.innerHTML = `<h3>${w.tr}</h3>
                <div class="card-detail-item"><b>T√ºr:</b> ${w.tt}</div>
                <div class="card-detail-item"><b>Tanƒ±m:</b> ${w.dt}</div>
                <div class="card-detail-item"><b>√ñrnek 1:</b> ${w.e1t}</div>
                <div class="card-detail-item"><b>√ñrnek 2:</b> ${w.e2t}</div>`;
        }
    }
    function toggleCardLang() { isEngMode = !isEngMode; updateCardContent(); }
    function cardAction(type) {
        if(type === 'know') db.unknown.splice(cIdx, 1);
        else cIdx = (cIdx + 1) % db.unknown.length;
        if(db.unknown.length > 0) { renderCard(); save(); } else show('home');
    }

    // READING & QUIZ
    let activeR = null; let qCounter = 0; let qScore = 0;
    function renderReadList() {
        document.getElementById('listLvlTitle').innerText = db.lvl + " Metinleri";
        const cont = document.getElementById('readItems'); cont.innerHTML = '';
        db.readings.filter(r => r.lvl === db.lvl).forEach(r => {
            const b = document.createElement('div'); b.className = 'btn'; b.style.background = 'var(--primary)';
            b.innerText = r.title; b.onclick = () => startReading(r);
            cont.appendChild(b);
        });
    }

    function startReading(r) {
        activeR = r; document.getElementById('readTitle').innerText = r.title;
        const area = document.getElementById('readArea'); area.innerHTML = '';
        r.en.split(/\s+/).forEach(word => {
            const span = document.createElement('span'); span.className = 'word-span'; span.innerText = word + " ";
            const clean = word.toLowerCase().replace(/[^a-z]/g, "");
            if(db.unknown.find(u => u.w === clean)) span.classList.add('is-unknown');
            span.onclick = () => {
                if(!db.unknown.find(u => u.w === clean)) {
                    const dictMatch = db.dictionary.find(x => x.w === clean);
                    db.unknown.push(dictMatch || {w:clean, tr:"?", te:"?", tt:"?", de:"?", dt:"?", e1:"?", e1t:"?", e2:"?", e2t:"?"});
                    span.classList.add('is-unknown'); save();
                }
            };
            area.appendChild(span);
        });
        show('readMod');
    }

    function startQuiz() { qCounter = 0; qScore = 0; show('quizScreen'); renderQuestion(); }
    function renderQuestion() {
        const q = activeR.qs[qCounter];
        document.getElementById('quizProgress').innerText = `${qCounter+1} / ${activeR.qs.length}`;
        document.getElementById('qText').innerText = q.q;
        const optCont = document.getElementById('qOptions'); optCont.innerHTML = '';
        ['A','B','C','D'].forEach(o => {
            const b = document.createElement('div'); b.className = 'btn'; b.style.background = '#fff'; b.style.color = '#000'; b.style.border = '1px solid #ddd';
            b.innerText = `${o}) ${q[o]}`;
            b.onclick = () => {
                if(o === q.correct) qScore++;
                qCounter++;
                if(qCounter < activeR.qs.length) renderQuestion(); else finishQuiz();
            };
            optCont.appendChild(b);
        });
    }

    function finishQuiz(manual = false) {
        if(manual && !confirm("Testi bitirmek istediƒüinize emin misiniz?")) return;
        const perc = Math.round((qScore / activeR.qs.length) * 100);
        document.getElementById('resPercent').innerText = `%${perc} Ba≈üarƒ± Saƒüladƒ±nƒ±z`;
        document.getElementById('resDetail').innerText = `${activeR.qs.length} soruda ${qScore} doƒüru cevap.`;
        db.stats.correct += qScore; db.stats.total += activeR.qs.length;
        db.stats.completed[activeR.lvl] = (db.stats.completed[activeR.lvl] || 0) + 1;
        save(); show('resultScreen');
    }

    // STATS & SYSTEM
    function showStats() {
        show('stats');
        const ctx = document.getElementById('statsChart').getContext('2d');
        if(window.chart) window.chart.destroy();
        window.chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['A1','A2','B1','B2','C1','C2'],
                datasets: [{ label: 'Biten Metinler', data: ['A1','A2','B1','B2','C1','C2'].map(l => db.stats.completed[l] || 0), backgroundColor: '#4f46e5' }]
            }
        });
        const avg = db.stats.total > 0 ? Math.round((db.stats.correct / db.stats.total)*100) : 0;
        document.getElementById('statsInfo').innerHTML = `
            <div class="streak-card" style="padding:15px; background:var(--warning)">
                <h3>Genel Ba≈üarƒ±: %${avg}</h3>
                <p>Havuzdaki Kelime: ${db.unknown.length}</p>
            </div>`;
    }

    function exportJSON() {
        const blob = new Blob([JSON.stringify(db)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'master_english_backup.json'; a.click();
    }
    function importJSON(i) {
        const r = new FileReader(); r.onload = (e) => { db = JSON.parse(e.target.result); save(); location.reload(); };
        r.readAsText(i.files[0]);
    }
    function resetAll() { if(confirm("T√ºm verileriniz silinecek!")) { localStorage.clear(); location.reload(); } }

    // AUDIO
    let synth = window.speechSynthesis;
    function playS() { synth.cancel(); let u = new SpeechSynthesisUtterance(activeR.en); u.rate = document.getElementById('speed').value; u.lang = 'en-US'; synth.speak(u); }
    function pauseS() { synth.pause(); }
    function stopS() { synth.cancel(); }
    function updateSpd() { document.getElementById('speedVal').innerText = document.getElementById('speed').value + "x"; }

    // INITIALIZATION
    load();
    const lvls = ['A1','A2','B1','B2','C1','C2'];
    const colors = ['var(--a1)','var(--a2)','var(--b1)','var(--b2)','var(--c1)','var(--c2)'];
    const grid = document.getElementById('lvlGrid');
    lvls.forEach((l, i) => {
        const b = document.createElement('button'); b.className = 'level-btn'; b.style.background = colors[i]; b.innerText = l;
        b.onclick = () => setLvl(l); if(db.lvl === l) b.classList.add('selected');
        grid.appendChild(b);
    });
</script>
</body>
</html>